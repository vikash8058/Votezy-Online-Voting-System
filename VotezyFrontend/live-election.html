<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Election - Voter Panel</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&family=Poppins:wght@600&display=swap" rel="stylesheet" />
  <style>
    /* Base Reset & Background */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: #e1e9f2;
      color: #f0f2f5;
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }

    /* Make all text dark for visibility on light background */
    html, body {
      color: #23235b;
    }

    /* Header */
    .header {
      height: 64px;
      background: #0d306c;
      /* Solid white navbar */
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .title {
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1.85rem;
      background: #0d306c;
      padding: 6px 18px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(74,44,153,0.07);
      text-shadow: none;
      color: #ffffff;
      user-select: none;
      pointer-events: none;
    }

    /* Back Button */
    .back-btn {
      background: linear-gradient(135deg, #5f6cff 0%, #3e52a1 100%);
      border: none;
      border-radius: 12px;
      padding: 0.6rem 1.5rem;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(58, 76, 147, 0.6);
      transition: background 0.3s;
    }

    .back-btn:hover, .back-btn:focus {
      background: linear-gradient(135deg, #3e52a1 0%, #5f6cff 100%);
      outline: none;
    }

    /* Main Content */
    main {
      max-width: 720px;
      margin: 1.5rem auto 3rem;
      padding: 0 1rem;
      text-align: center;
    }

    h1.election-title {
      font-family: 'Poppins', sans-serif;
      font-size: 2.8rem;
      font-weight: 700;
      margin-bottom: 0.8rem;
      color: #23235b;
      text-shadow: none;
      user-select: text;
    }

    .election-status {
      font-size: 1.2rem;
      color: #3e52a1;
      margin-bottom: 2rem;
      letter-spacing: 0.03em;
      user-select: text;
    }

    .countdown {
      font-weight: 700;
      font-family: monospace, monospace;
      font-size: 2rem;
      color: #23235b;
      margin-bottom: 3rem;
      letter-spacing: 0.1em;
    }

    /* Candidate List */
    .candidates {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .candidate {
      background: #f5f7fa;
      color: #23235b;
      padding: 1rem 1.5rem;
      border-radius: 14px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.3s;
    }
    .candidate:hover, .candidate:focus-within {
      background: rgba(255,255,255,0.15);
      outline: none;
    }
    .candidate-info {
      text-align: left;
    }
    .candidate-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: #23235b;
      margin: 0 0 0.3rem;
      user-select: text;
    }
    .candidate-party {
      font-size: 1.05rem;
      color: #4a2c99;
      user-select: text;
      margin: 0;
    }

    /* Vote Button */
    .vote-btn {
      background: linear-gradient(90deg, #4a2c99 0%, #5f6cff 100%);
      border: none;
      border-radius: 26px;
      padding: 0.8rem 2.2rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 24px rgba(69, 201, 209, 0.6);
      transition: background 0.25s, box-shadow 0.25s;
      user-select: none;
      flex-shrink: 0;
    }
    .vote-btn:hover, .vote-btn:focus {
      background: linear-gradient(90deg, #3e52a1 0%, #5f6cff 100%);
      box-shadow: 0 6px 28px rgba(60, 182, 195, 0.75);
      outline: none;
    }

    /* Show Results Button */
    #showResultsBtn {
      display: inline-block;
      margin-top: 2rem;
      font-weight: 600;
      font-size: 1.2rem;
      padding: 0.7rem 1.5rem;
      border-radius: 12px;
      border: none;
      background: #4a2c99;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      user-select: none;
    }
    #showResultsBtn:hover, #showResultsBtn:focus {
      background: #3f2484;
      outline: none;
    }

    /* Results Container */
    #resultsContainer {
      display: none;
      margin-top: 1rem;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
      color: #e2e8ff;
      user-select: text;
      text-align: left;
    }

    /* Error & info messages */
    .message-box {
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      color: #d7263d;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1rem;
    }

    /* Winner Highlight */
    .winner-box {
      background: #e7ecfa;
      color: #23235b;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 12px #bfc8e6;
      user-select: text;
    }
    .winner-box h2 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: #23235b;
    }
    .winner-box p {
      margin: 0.2rem 0 0.6rem;
      color: #3e52a1;
      font-size: 1.1rem;
    }
    .winner-box .votes {
      font-weight: 600;
      font-size: 1.2rem;
      color: #3e52a1;
    }

    /* Results Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.1rem;
    }
    th, td {
      padding: 0.6rem 1rem;
    }
    th {
      text-align: left;
      border-bottom: 2px solid #bfc8e6;
    }
    td {
      border-bottom: 1px solid #e3e9f7;
    }
    td.votes {
      text-align: right;
      font-weight: 600;
    }

    /* Info Cards */
    .info-cards {
      display: flex;
      gap: 2rem;
      justify-content: center;
      margin: 2.5rem 0 2rem 0;
      flex-wrap: wrap;
    }
    .info-card {
      background: #2a3a6f;
      color: #e2e8ff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(74,44,153,0.13);
      padding: 1.2rem 1.5rem;
      min-width: 200px;
      max-width: 260px;
      flex: 1 1 200px;
      display: flex;
      align-items: flex-start;
      gap: 1.1rem;
      margin-bottom: 1rem;
    }
    .info-icon {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .info-card h3 {
      margin: 0 0 0.2rem 0;
      font-size: 1.08rem;
      font-weight: 700;
      color: #8bf6ff;
    }
    .info-card p {
      margin: 0;
      font-size: 0.98rem;
      color: #e2e8ff;
    }

    /* How to Vote & FAQ Sections */
    .how-vote, .faq-section {
      background: #f5f7fa;
      border-radius: 14px;
      box-shadow: 0 2px 12px rgba(74,44,153,0.08);
      padding: 2rem 2.5rem;
      margin: 2.5rem auto 0 auto;
      max-width: 700px;
    }
    .how-vote h2, .faq-section h2 {
      color: #3e52a1;
      margin-top: 0;
      margin-bottom: 1.2rem;
      font-size: 1.3rem;
      font-weight: 700;
    }
    .how-vote ol {
      color: #23235b;
      font-size: 1.08rem;
      margin-left: 1.2rem;
    }
    .faq {
      margin-bottom: 1.2rem;
    }
    .faq h4 {
      margin: 0 0 0.2rem 0;
      color: #4a2c99;
      font-size: 1.08rem;
    }
    .faq p {
      margin: 0 0 0.7rem 0;
      color: #23235b;
      font-size: 1rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .info-cards {
        flex-direction: column;
        align-items: center;
        gap: 1.2rem;
      }
      .info-card {
        max-width: 95vw;
        min-width: 0;
        width: 100%;
      }
      .how-vote, .faq-section {
        padding: 1.2rem 1rem;
      }
    }
    @media (max-width: 480px) {
      main {
        margin: 1rem auto 2rem;
        padding: 0 1rem;
      }
      .candidate {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      .vote-btn {
        width: 100%;
        text-align: center;
      }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      tr {
        margin-bottom: 1rem;
      }
      th {
        background: #2e3c64;
        padding: 0.5rem;
        border: none;
      }
      td {
        padding: 0.5rem 1rem;
        border: none;
        border-bottom: 1px solid #5a5f9a;
      }
      td.votes {
        text-align: left;
      }
    }
  </style>
</head>
<body>

  <header class="header" role="banner">
    <button 
      class="back-btn" 
      onclick="location.href='voter.html'" 
      aria-label="Back to Dashboard"
      type="button"
    >
      Back
    </button>
    <div class="title">Election Details</div>
    <div style="width:80px;"></div> <!-- Empty placeholder for symmetry -->
  </header>

  <main>
    <h1 class="election-title" tabindex="0">Loading election name...</h1>
    <div class="election-status" aria-live="polite" aria-atomic="true" tabindex="0">Loading election status...</div>
    <div class="countdown" role="timer" aria-live="polite" aria-atomic="true" aria-label="Time remaining for voting" tabindex="0" id="countdownTimer">Loading...</div>

    <section class="candidates" aria-label="Candidates List">
      <!-- Candidates will be populated dynamically -->
    </section>

    <button id="showResultsBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="resultsContainer">
      Show Results
    </button>

    <div id="resultsContainer" aria-live="polite" aria-atomic="true" tabindex="0"></div>

    <section class="how-vote">
      <h2>How to Vote</h2>
      <ol>
        <li>Review the list of candidates and their manifestos.</li>
        <li>Select your preferred candidate and click <b>Vote</b>.</li>
        <li>Wait for the election to end to see the results.</li>
      </ol>
    </section>

    <section class="faq-section">
      <h2>Frequently Asked Questions</h2>
      <div class="faq">
        <h4>Is my vote confidential?</h4>
        <p>Yes, your vote is completely confidential and securely stored.</p>
      </div>
      <div class="faq">
        <h4>How do I know if my vote was counted?</h4>
        <p>After voting, you will receive a confirmation and can check your voting history.</p>
      </div>
      <div class="faq">
        <h4>Who can I contact for help?</h4>
        <p>Contact support at <a href="mailto:support@votezy.com">support@votezy.com</a> for any assistance.</p>
      </div>
    </section>
  </main>

  <script>
    const electionTitleEl = document.querySelector('.election-title');
    const electionStatusEl = document.querySelector('.election-status');
    const countdownTimer = document.getElementById('countdownTimer');
    const candidatesContainer = document.querySelector('.candidates');
    const showResultsBtn = document.getElementById('showResultsBtn');
    const resultsContainer = document.getElementById('resultsContainer');

    let countdownInterval = null;
    let election = null; // store election data for reuse

    // Fetch current election info including status and times
    async function fetchCurrentElection() {
      try {
        const response = await fetch('/api/election/current');
        if (!response.ok) throw new Error('Failed to fetch election info');
        return await response.json();
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    // Fetch candidates linked to the election
    async function fetchCandidates(electionId) {
      try {
        const response = await fetch(`/api/election/${electionId}/candidates`);
        if (!response.ok) throw new Error('Failed to fetch candidates');
        return await response.json();
      } catch (error) {
        console.error(error);
        return [];
      }
    }

    // Fetch election results by election id
    async function fetchResults(electionId) {
      try {
        const response = await fetch(`/api/election/${electionId}/results`);
        if (!response.ok) throw new Error('Failed to fetch results');
        return await response.json();
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    // Render candidate cards dynamically
    function renderCandidates(candidates) {
      if (!candidates.length) {
        candidatesContainer.innerHTML = '<p>No candidates available for this election.</p>';
        return;
      }
      candidatesContainer.innerHTML = '';
      candidates.forEach(candidate => {
        const card = document.createElement('article');
        card.className = 'candidate';
        card.tabIndex = 0;
        card.innerHTML = `
          <div class="candidate-info">
            <h2 class="candidate-name">${candidate.name}</h2>
            <p class="candidate-party">${candidate.party}</p>
          </div>
          <button class="vote-btn" type="button" aria-label="Vote for ${candidate.name}" onclick="vote('${candidate.name}')">Vote</button>
        `;
        candidatesContainer.appendChild(card);
      });
    }

    // Render results inside the container as a table and show winner prominently
    function renderResultsWithWinner(results) {
      if (!results || !results.length) {
        resultsContainer.innerHTML = '<p>No results available yet.</p>';
        return;
      }

      // Find winner (candidate with max votes)
      const winner = results.reduce((max, candidate) => 
        candidate.votes > max.votes ? candidate : max, results[0]);

      // Winner Section
      let html = `
        <h3 style="text-align:center; margin-bottom:1rem; color:#8bf6ff;">Winner</h3>
        <div class="winner-box">
          <h2>${winner.candidateName}</h2>
          <p>${winner.party}</p>
          <p class="votes">Votes: ${winner.votes.toLocaleString()}</p>
        </div>
      `;

      // Full Results Table
      html += `
        <h3 style="text-align:center; margin-bottom: 1rem;">Full Election Results</h3>
        <table>
          <thead>
            <tr>
              <th>Candidate</th>
              <th>Party</th>
              <th class="votes">Votes</th>
            </tr>
          </thead>
          <tbody>
      `;

      results.forEach(r => {
        html += `
          <tr>
            <td>${r.candidateName}</td>
            <td>${r.party}</td>
            <td class="votes">${r.votes.toLocaleString()}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      resultsContainer.innerHTML = html;
    }

    // Placeholder vote function - replace with actual backend call as needed
    function vote(candidateName) {
      alert(`You voted for ${candidateName}. Thank you for your participation!`);
      // TODO: Implement actual vote submission logic here
    }

    // Update countdown timer while election is open
    function startCountdown(endTime) {
      if (countdownInterval) clearInterval(countdownInterval);
      const end = new Date(endTime);

      function update() {
        const now = new Date();
        let diff = end - now;

        if (diff <= 0) {
          countdownTimer.textContent = 'Election Closed';
          clearInterval(countdownInterval);
          return;
        }

        const hrs = Math.floor(diff / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        countdownTimer.textContent = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
      }

      update();
      countdownInterval = setInterval(update, 1000);
    }

    // Show results button click handler
    async function onShowResultsClick() {
      const now = new Date();
      const startTime = new Date(election.startTime || election.start_time);
      const endTime = new Date(election.endTime || election.end_time);

      // Show the results container so messages/results appear
      resultsContainer.style.display = 'block';

      if (now < startTime) {
        // Election has not started
        resultsContainer.innerHTML = `
          <div class="message-box">
            Election has not started yet. Results will be available after election ends.
          </div>
        `;
      }
      else if (now >= startTime && now < endTime) {
        // Election in progress
        resultsContainer.innerHTML = `
          <div class="message-box">
            Election is currently in progress. Results will be available once voting is completed.
          </div>
        `;
      }
      else {
        // Election ended - fetch and display results
        const resultsData = await fetchResults(election.id);
        if (!resultsData || !resultsData.results || resultsData.results.length === 0) {
          resultsContainer.innerHTML = `
            <div class="message-box">
              No results available yet. Please try again later.
            </div>
          `;
          return;
        }
        renderResultsWithWinner(resultsData.results);
      }

      // Toggle button text and aria-expanded state for accessibility
      if (showResultsBtn.textContent === 'Show Results') {
        showResultsBtn.textContent = 'Hide Results';
        showResultsBtn.setAttribute('aria-expanded', 'true');
      } else {
        resultsContainer.style.display = 'none';
        showResultsBtn.textContent = 'Show Results';
        showResultsBtn.setAttribute('aria-expanded', 'false');
      }
    }

    // Initialize page content on load
    async function initializeLiveElectionPage() {
      election = await fetchCurrentElection();

      if (!election) {
        electionTitleEl.textContent = 'No Active Election';
        electionStatusEl.textContent = '';
        countdownTimer.textContent = '';
        showResultsBtn.style.display = 'none';
        candidatesContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        return;
      }

      electionTitleEl.textContent = election.name || 'Untitled Election';

      const now = new Date();
      const startTime = new Date(election.startTime || election.start_time);
      const endTime = new Date(election.endTime || election.end_time);

      if (now < startTime) {
        electionStatusEl.textContent = 'Election not started yet';
        countdownTimer.textContent = '';
      }
      else if (now >= startTime && now < endTime) {
        electionStatusEl.textContent = 'Election is OPEN';
        startCountdown(endTime);
      } else {
        electionStatusEl.textContent = 'Election Closed';
        countdownTimer.textContent = '00:00:00';
      }

      // Render candidates
      const candidates = await fetchCandidates(election.id);
      renderCandidates(candidates);

      // Show Results button is always visible, attach event
      showResultsBtn.style.display = 'inline-block';
      showResultsBtn.onclick = onShowResultsClick;

      // Initialize aria-expanded for accessibility
      showResultsBtn.setAttribute('aria-expanded', 'false');
    }

    // Start initialization on DOM ready
    window.addEventListener('DOMContentLoaded', initializeLiveElectionPage);
  </script>
</body>
</html>
